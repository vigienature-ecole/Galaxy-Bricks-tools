<tool id="lubridate_convert" name="Convertir des dates">
    <requirements>
        <requirement type="package" version="1.7.4">r-lubridate</requirement>
        <requirement type="package" version="1.12.2">r-data.table</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        cat '$script' &&
        Rscript '$script'
    ]]></command>
    <configfiles>
        <configfile name="script"><![CDATA[
            ## Setup R error handling to go to stderr
            options(show.error.messages=F, error=function(){cat(geterrmessage(), file=stderr()); q("no",1,F)})

            ## Unify locale settings
            loc <- Sys.setlocale("LC_MESSAGES", "en_US.UTF-8")

            ## Import library
            library(lubridate)
            library(data.table)

            ## Import file
            input1 <- data.frame(fread('$input'))

            ## Add new column
            #for $i, $s in enumerate($series)
            rank_of_series=$i

            ## Parse time
            result <- parse_date_time(input1[ , $s.column], '$s.inputDateFormat')

            #if $s.outputDateFormat == "second"
                result <- second(result)
            #elif $s.outputDateFormat == "minute"
                result <- minute(result)
            #elif $s.outputDateFormat == "hour"
                result <- hour(result)
            #elif $s.outputDateFormat == "day"
                result <- day(result)
            #elif $s.outputDateFormat == "yday"
                result <- yday(result)
            #elif $s.outputDateFormat == "mday"
                result <- mday(result)
            #elif $s.outputDateFormat == "wday"
                result <- wday(result)
            #elif $s.outputDateFormat == "week"
                result <- week(result)
            #elif $s.outputDateFormat == "month"
                result <- month(result)
            #elif $s.outputDateFormat == "year"
                result <- year(result)
            #elif $s.outputDateFormat == "timeZone"
                result <- tz(result)
            #elif $s.outputDateFormat == "dst"
                result <- dst(result)
            #end if

            #if $addToData == "TRUE"
                input1 <- data.frame(input1, res = result)
                colnames(input1)[ncol(input1)] <- '$s.inputName'
            #end if
            #end for

            write.table(input1, file="result", row.names=FALSE, sep="\t")

        ]]></configfile>
    </configfiles>

    <inputs>
        <param format="tabular,csv,txt" name="input" type="data" label="Input file" />
        <param falsevalue="FALSE" label="Ajouter le résultat au jeu de données initial" name="addToData" truevalue="TRUE" type="boolean" />
        <repeat name="series" title="Series">
            <param name="column" type="integer" value="2" label="Numéro de la colonne d'entrée" />
            <param name="inputName" type="text" value="date" label="Nom de la colonne résultante" />
            <param name="inputDateFormat" type="select" label="Choisir le format des données d'entrée" help="A pour année, M pour mois et J pour jour">
                <option value="dmy" selected="true">JMA</option>
                <option value="mdy">MJA</option>
                <option value="ymd">AMJ</option>
            </param>
            <param name="outputDateFormat" type="select" label="Choisir le format de sortie">
                <option value="full" selected="true">Complet</option>
                <option value="year">Année</option>
                <option value="month">Mois</option>
                <option value="day">Jour</option>
                <option value="week">Semaine</option>
                <option value="yday">Jour de l'année (~1-365)</option>
	             	<option value="mday">Jour du mois (~1-30)</option>
                <option value="wday">Jour de la semaine (1-7)</option>
                <option value="timeZone">Fuseau horaire</option>
            </param>
        </repeat>
    </inputs>
    <outputs>
        <data format="tabular" name="output" from_work_dir="result"/>
    </outputs>
    <tests>
        <test>
            <param name="input" value="input-lubridate.tabular"/>
            <param name="addToData" value="TRUE"/>
            <param name="column" value="3"/>
            <param name="inputName" value="date"/>
            <param name="inputDateFormat" value="DMY"/>
            <param name="outputDateFormat" value="full"/>
            <output name="output" file="out-lubridate.tabular"/>
        </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

This tool converts dates to standart format
 * choose input format
 * choose output format

**Example**

input dataset ::

 ID   dateIn
 1   12/10/2019
 2   12.10.2019
 3   12-10-2019
 4 12//10//2019
 5   12/10*2019

 Parameters :

 Add column : No
 insert serie
 Number of the column to parse: 2
 Name of the resulting column: date
 choose input date format: dmy
 choose output date format: full
 insert serie
 Number of the column to parse: 2
 Name of the resulting column: Day of the year
 choose input date format: dmy
 choose output date format: Day of the year

Result ::

    date     Day of the year
 2019-10-12       285
 2019-10-12       285
 2019-10-12       285
 2019-10-12       285
 2019-10-12       285

    ]]></help>
</tool>
